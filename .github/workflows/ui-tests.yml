name: UI Tests (XCUITest)

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  ui-test:
    name: XCUITest
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Build and Test
        id: test
        continue-on-error: true
        run: |
          # Run UI tests with xcodebuild
          set -o pipefail
          xcodebuild test \
            -project TaskScratchpad.xcodeproj \
            -scheme TaskScratchpad \
            -destination 'platform=macOS' \
            -derivedDataPath build/DerivedData \
            -resultBundlePath build/TestResults.xcresult \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee uitest-output.log
          
          TEST_EXIT_CODE=$?
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit $TEST_EXIT_CODE

      - name: Parse Test Results
        if: always()
        run: |
          echo "## ðŸ§ª UI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f uitest-output.log ]; then
            # Extract test summary from xcodebuild output
            # Look for lines like: "Executed X tests, with Y failures"
            SUMMARY=$(grep -E "Executed [0-9]+ tests" uitest-output.log | tail -1 || echo "")
            
            if [ -n "$SUMMARY" ]; then
              echo "**Summary:** $SUMMARY" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Count passed tests (lines containing "passed")
            PASSED=$(grep -c "passed" uitest-output.log 2>/dev/null || echo "0")
            FAILED=$(grep -c "failed" uitest-output.log 2>/dev/null || echo "0")
            
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show individual test results
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“‹ Test Details</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "Test (Case|case)" uitest-output.log | head -50 >> $GITHUB_STEP_SUMMARY || echo "No test details found"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            
            # Check for TEST SUCCEEDED or failures
            if grep -q "TEST SUCCEEDED" uitest-output.log; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âœ… All UI Tests Passed!" >> $GITHUB_STEP_SUMMARY
            elif grep -q "TEST FAILED" uitest-output.log; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âŒ Some UI Tests Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>Failure Details</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A 5 "failed" uitest-output.log | head -100 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No test output log found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-results
          path: |
            build/TestResults.xcresult
            uitest-output.log
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-screenshots
          path: build/DerivedData/**/Attachments/**/*.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Check Test Result
        if: always()
        run: |
          if [ "${{ steps.test.outputs.test_exit_code }}" != "0" ]; then
            echo "UI tests failed with exit code ${{ steps.test.outputs.test_exit_code }}"
            # Don't fail the workflow for now - UI tests are informational
            # exit 1
          fi
