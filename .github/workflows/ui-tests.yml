name: UI Tests (XCUITest)

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  ui-test:
    name: XCUITest
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode Version
        run: |
          xcodebuild -version
          xcrun simctl list devices available

      - name: Build App for Testing
        run: |
          # First build the SPM executable
          swift build -v
          
          # Create the app bundle structure for UI testing
          mkdir -p build/TaskScratchpad.app/Contents/MacOS
          mkdir -p build/TaskScratchpad.app/Contents/Resources
          
          # Copy the built executable
          ARCH=$(uname -m)
          cp .build/${ARCH}-apple-macosx/debug/TaskScratchpad build/TaskScratchpad.app/Contents/MacOS/
          
          # Copy icon if exists
          if [ -f Resources/AppIcon.icns ]; then
            cp Resources/AppIcon.icns build/TaskScratchpad.app/Contents/Resources/
          fi
          
          # Create Info.plist
          cat > build/TaskScratchpad.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>TaskScratchpad</string>
            <key>CFBundleIdentifier</key>
            <string>com.taskscratchpad.app</string>
            <key>CFBundleName</key>
            <string>TaskScratchpad</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSMinimumSystemVersion</key>
            <string>14.0</string>
            <key>CFBundleIconFile</key>
            <string>AppIcon</string>
            <key>NSHighResolutionCapable</key>
            <true/>
          </dict>
          </plist>
          EOF
          
          # Create PkgInfo
          echo -n "APPL????" > build/TaskScratchpad.app/Contents/PkgInfo
          
          echo "App bundle created successfully"
          ls -la build/TaskScratchpad.app/Contents/

      - name: Build UI Tests
        run: |
          # Build the UI test bundle using xcodebuild
          xcodebuild build-for-testing \
            -project TaskScratchpad.xcodeproj \
            -scheme TaskScratchpad \
            -destination 'platform=macOS' \
            -derivedDataPath build/DerivedData \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | xcbeautify || true
            
          # Show what was built
          find build/DerivedData -name "*.xctest" -type d 2>/dev/null || echo "UI test bundle location will be in derived data"

      - name: Run UI Tests
        continue-on-error: true
        run: |
          # Run UI tests with xcodebuild
          xcodebuild test \
            -project TaskScratchpad.xcodeproj \
            -scheme TaskScratchpad \
            -destination 'platform=macOS' \
            -derivedDataPath build/DerivedData \
            -resultBundlePath build/TestResults.xcresult \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee uitest-output.log | xcbeautify || true

      - name: Parse Test Results
        if: always()
        run: |
          # Check if tests passed by looking at the log
          if grep -q "Test session results" uitest-output.log 2>/dev/null; then
            echo "## ðŸ§ª UI Test Results" >> $GITHUB_STEP_SUMMARY
            
            # Count passed/failed from log
            PASSED=$(grep -c "âœ“" uitest-output.log 2>/dev/null || echo "0")
            FAILED=$(grep -c "âœ—" uitest-output.log 2>/dev/null || echo "0")
            
            echo "- âœ… Tests Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Tests Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
          elif grep -q "Failing tests:" uitest-output.log 2>/dev/null; then
            echo "## ðŸ§ª UI Test Results - Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            grep -A 50 "Failing tests:" uitest-output.log >> $GITHUB_STEP_SUMMARY || true
          else
            echo "## ðŸ§ª UI Tests" >> $GITHUB_STEP_SUMMARY
            echo "See artifacts for detailed results" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-results
          path: |
            build/TestResults.xcresult
            uitest-output.log
          retention-days: 14

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-screenshots
          path: |
            build/DerivedData/**/Attachments/**/*.png
            build/DerivedData/**/Attachments/**/*.jpg
          if-no-files-found: ignore
          retention-days: 14

